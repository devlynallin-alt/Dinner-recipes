{% extends 'base.html' %}

{% block title %}{{ recipe.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 id="recipeTitle">{{ recipe.name }}</h2>
    <div>
        <button id="cookModeBtn" class="btn btn-success" onclick="toggleCookMode()">
            <i class="bi bi-fire"></i> Cook Mode
        </button>
        <a href="{{ url_for('recipe_edit', id=recipe.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <form method="post" action="{{ url_for('recipe_delete', id=recipe.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this recipe?');">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
        <a href="{{ url_for('recipes_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Cook Mode Banner -->
<div id="cookModeBanner" class="alert alert-success d-none mb-3">
    <i class="bi bi-fire"></i> <strong>Cook Mode Active</strong> - Screen will stay on. Tap "Exit Cook Mode" when done.
</div>

<div class="row">
    <div class="col-md-4">
        {% if recipe.image %}
        <div class="card mb-3">
            <img src="{{ url_for('static', filename='uploads/' + recipe.image) }}" class="card-img-top" alt="{{ recipe.name }}" style="max-height: 250px; object-fit: cover;">
        </div>
        {% endif %}
        <div class="card">
            <div class="card-header">Recipe Info</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Category</span>
                    <span class="badge bg-secondary">{{ recipe.category }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Protein Type</span>
                    <span class="badge bg-info">{{ recipe.protein_type }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Difficulty</span>
                    <span class="badge {{ 'bg-warning' if recipe.difficulty == 'Hard' else 'bg-success' }}">{{ recipe.difficulty }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Servings</span>
                    <span>{{ recipe.servings }}</span>
                </li>
            </ul>
            {% if recipe.source_url %}
            <div class="card-footer">
                <a href="{{ recipe.source_url }}" target="_blank" class="btn btn-outline-info btn-sm w-100">
                    <i class="bi bi-box-arrow-up-right"></i> Original Recipe
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">Ingredients</div>
            <table class="table table-striped mb-0" id="ingredientsTable">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ri in recipe.ingredients %}
                    <tr>
                        <td>{{ ri.ingredient.name }}</td>
                        <td>
                            {% if ri.size %}
                                {{ ri.quantity|int }} x {{ ri.size|int }}{{ ri.unit.lower() }}
                            {% else %}
                                {{ ri.quantity }}
                            {% endif %}
                        </td>
                        <td>{% if not ri.size %}{{ ri.unit }}{% endif %}</td>
                        <td><span class="badge bg-light text-dark">{{ ri.ingredient.category }}</span></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-muted">No ingredients added yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if recipe.instructions %}
<div class="card mt-4">
    <div class="card-header">Instructions</div>
    <div class="card-body">
        <div id="instructionsText" style="white-space: pre-wrap;">{{ recipe.instructions }}</div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
.cook-mode {
    font-size: 1.2em;
}
.cook-mode #instructionsText {
    font-size: 1.3em;
    line-height: 1.8;
}
.cook-mode #ingredientsTable {
    font-size: 1.1em;
}
.cook-mode #recipeTitle {
    font-size: 2em;
}
</style>
<script>
let wakeLock = null;
let cookModeActive = false;

async function toggleCookMode() {
    const btn = document.getElementById('cookModeBtn');
    const banner = document.getElementById('cookModeBanner');
    const body = document.body;

    if (!cookModeActive) {
        // Enable cook mode
        try {
            // Request wake lock to keep screen on
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake lock acquired');
            }
        } catch (err) {
            console.log('Wake lock failed:', err);
        }

        // Enable larger text
        body.classList.add('cook-mode');
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Exit Cook Mode';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        banner.classList.remove('d-none');
        cookModeActive = true;

    } else {
        // Disable cook mode
        if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            console.log('Wake lock released');
        }

        body.classList.remove('cook-mode');
        btn.innerHTML = '<i class="bi bi-fire"></i> Cook Mode';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
        banner.classList.add('d-none');
        cookModeActive = false;
    }
}

// Re-acquire wake lock if page becomes visible again
document.addEventListener('visibilitychange', async () => {
    if (cookModeActive && document.visibilityState === 'visible' && 'wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
        } catch (err) {
            console.log('Wake lock reacquire failed:', err);
        }
    }
});
</script>
{% endblock %}
