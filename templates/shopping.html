{% extends 'base.html' %}

{% block title %}Shopping List{% endblock %}

{% block content %}
{% set pantry_names = pantry_names or [] %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-cart"></i> Shopping List</h2>
    <div>
        <button onclick="window.print()" class="btn btn-outline-primary">
            <i class="bi bi-printer"></i> Print
        </button>
        {% if items|selectattr('checked')|list|length > 0 %}
        <form method="post" action="{{ url_for('shopping_clear_checked') }}" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-counterclockwise"></i> Restore Checked
            </button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Add Item Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="post" action="{{ url_for('shopping_add') }}" class="row g-2">
            <div class="col-md-5">
                <input type="text" name="name" class="form-control" placeholder="Item name..." required>
            </div>
            <div class="col-md-2">
                <input type="text" name="quantity" class="form-control" placeholder="Qty (e.g. 2 lbs)">
            </div>
            <div class="col-md-3">
                <select name="category" class="form-select">
                    {% for cat in categories %}
                    <option value="{{ cat }}" {{ 'selected' if cat == 'Other' else '' }}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-plus-lg"></i> Add
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Shopping List -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-bag"></i> Items ({{ items|rejectattr('checked')|list|length }} remaining)
    </div>
    <table class="table table-hover mb-0">
        <tbody>
            {% set current_category = namespace(value='') %}
            {% for item in items %}
                {% if item.category != current_category.value and not item.checked %}
                    {% set current_category.value = item.category %}
                    <tr class="table-secondary">
                        <td colspan="8"><strong>{{ item.category }}</strong></td>
                    </tr>
                {% endif %}
                {% if not item.checked %}
                {% set qty_parts = item.quantity.split('|') if '|' in item.quantity else [item.quantity, ''] %}
                <tr>
                    <td style="width: 50px;">
                        <form method="post" action="{{ url_for('shopping_check', id=item.id) }}">
                            <button type="submit" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </form>
                    </td>
                    <td>{{ item.name }}</td>
                    <td class="text-muted" style="width: 100px;">{{ qty_parts[0] }}</td>
                    <td class="text-muted" style="width: 100px;">{{ qty_parts[1] if qty_parts|length > 1 else '' }}</td>
                    <td class="text-muted text-end" style="width: 90px;">{{ item.unit_cost }}</td>
                    <td class="text-end" style="width: 80px;">{% if item.cost %}${{ '%.2f'|format(item.cost) }}{% endif %}</td>
                    <td style="width: 100px;">
                        {% if item.name.lower() not in pantry_names %}
                        <form method="post" action="{{ url_for('shopping_add_to_pantry', id=item.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Add to Pantry">
                                <i class="bi bi-house-add"></i>
                            </button>
                        </form>
                        {% else %}
                        <span class="btn btn-sm btn-success disabled" title="In Pantry">
                            <i class="bi bi-house-check"></i>
                        </span>
                        {% endif %}
                        <form method="post" action="{{ url_for('shopping_delete', id=item.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-x"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endif %}
            {% else %}
                <tr>
                    <td colspan="8" class="text-muted text-center py-4">
                        <i class="bi bi-cart"></i> Your shopping list is empty
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% set unchecked_items = items|rejectattr('checked')|list %}
    {% set subtotal = unchecked_items|sum(attribute='cost') %}
    {% if subtotal > 0 %}
    <div class="card-footer">
        <div class="row">
            <div class="col-8 text-end"><strong>Subtotal:</strong></div>
            <div class="col-4 text-end">${{ '%.2f'|format(subtotal) }}</div>
        </div>
        <div class="row">
            <div class="col-8 text-end"><strong>Tax (12%):</strong></div>
            <div class="col-4 text-end">${{ '%.2f'|format(subtotal * 0.12) }}</div>
        </div>
        <div class="row">
            <div class="col-8 text-end"><strong>Total:</strong></div>
            <div class="col-4 text-end"><strong>${{ '%.2f'|format(subtotal * 1.12) }}</strong></div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Checked Items -->
{% set checked_items = items|selectattr('checked')|list %}
{% if checked_items|length > 0 %}
<div class="card mt-4">
    <div class="card-header text-muted">
        <i class="bi bi-check-circle"></i> Checked Off ({{ checked_items|length }})
    </div>
    <table class="table table-sm mb-0">
        <tbody>
            {% for item in checked_items %}
            {% set qty_parts = item.quantity.split('|') if '|' in item.quantity else [item.quantity, ''] %}
            <tr class="text-muted" style="text-decoration: line-through;">
                <td style="width: 50px;">
                    <form method="post" action="{{ url_for('shopping_check', id=item.id) }}">
                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                    </form>
                </td>
                <td>{{ item.name }}</td>
                <td>{{ qty_parts[0] }}</td>
                <td>{{ qty_parts[1] if qty_parts|length > 1 else '' }}</td>
                <td class="text-end">{{ item.unit_cost }}</td>
                <td class="text-end">{% if item.cost %}${{ '%.2f'|format(item.cost) }}{% endif %}</td>
                <td style="width: 50px;">
                    <form method="post" action="{{ url_for('shopping_delete', id=item.id) }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-x"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="mt-3">
    <small class="text-muted">
        <i class="bi bi-lightbulb"></i> Tip: Go to <a href="{{ url_for('recipes_list') }}">Recipes</a> and select recipes to add their ingredients here.
    </small>
</div>
{% endblock %}

{% block scripts %}
<style>
@media print {
    .btn, form, .card-body:first-of-type, .text-muted.mt-3 { display: none !important; }
    .card { border: none !important; }
    .card-header { background: none !important; border-bottom: 2px solid #000 !important; }
}
</style>
{% endblock %}
