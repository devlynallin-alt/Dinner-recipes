{% extends 'base.html' %}

{% block title %}Shopping List{% endblock %}

{% block content %}
<h2><i class="bi bi-cart"></i> Shopping List</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Select Recipes</span>
                <span class="badge bg-primary" id="selectedCount">0 selected</span>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search recipes...">
                    </div>
                    <div class="col-md-6">
                        <select id="categoryFilter" class="form-select">
                            <option value="">All Categories</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Breakfast">Breakfast</option>
                            <option value="Soup">Soup</option>
                            <option value="Sandwich">Sandwich</option>
                            <option value="Dessert">Dessert</option>
                            <option value="Side">Side</option>
                        </select>
                    </div>
                </div>

                <form method="post" action="{{ url_for('shopping_generate') }}">
                    <table class="table table-sm" id="recipeTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>Recipe</th>
                                <th>Category</th>
                                <th>Multiply</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for recipe in recipes %}
                            <tr data-name="{{ recipe.name.lower() }}" data-category="{{ recipe.category }}">
                                <td>
                                    <input type="checkbox" name="recipes" value="{{ recipe.id }}" class="recipe-checkbox">
                                </td>
                                <td>{{ recipe.name }}</td>
                                <td><span class="badge bg-secondary">{{ recipe.category }}</span></td>
                                <td style="width: 80px;">
                                    <input type="number" name="multiplier_{{ recipe.id }}" class="form-control form-control-sm" value="1" min="0.5" step="0.5">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-cart-check"></i> Generate Shopping List
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-recycle"></i> USE UP List
            </div>
            <div class="card-body">
                <p class="small text-muted">Ingredients to prioritize using</p>

                {% for item in use_up_items %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-success">{{ item.ingredient.name }}</span>
                    <form method="post" action="{{ url_for('useup_delete', id=item.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-x"></i>
                        </button>
                    </form>
                </div>
                {% endfor %}

                <hr>
                <form method="post" action="{{ url_for('useup_add') }}">
                    <div class="input-group">
                        <select name="ingredient_id" class="form-select form-select-sm" required>
                            <option value="">Add ingredient...</option>
                            {% for ing in ingredients %}
                            <option value="{{ ing.id }}">{{ ing.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Select all checkbox
document.getElementById('selectAll').addEventListener('change', function() {
    // Only select visible checkboxes
    document.querySelectorAll('#recipeTable tbody tr:not([style*="display: none"]) .recipe-checkbox').forEach(cb => {
        cb.checked = this.checked;
    });
    updateSelectedCount();
});

// Update selected count
function updateSelectedCount() {
    const count = document.querySelectorAll('.recipe-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count + ' selected';
}

// Track checkbox changes
document.querySelectorAll('.recipe-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

// Search and filter function
function filterRecipes() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;

    document.querySelectorAll('#recipeTable tbody tr').forEach(row => {
        const name = row.dataset.name;
        const rowCategory = row.dataset.category;

        const matchesSearch = name.includes(search);
        const matchesCategory = !category || rowCategory === category;

        row.style.display = (matchesSearch && matchesCategory) ? '' : 'none';
    });
}

// Event listeners for search and filter
document.getElementById('searchInput').addEventListener('input', filterRecipes);
document.getElementById('categoryFilter').addEventListener('change', filterRecipes);
</script>
{% endblock %}
